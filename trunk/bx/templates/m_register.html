{% extends "m_base.html" %}
{% block header_title %}注册账号{% endblock %}
{% block title %}注册账号-保险管家{% endblock %}
{% block keywords %}注册账号 保险管家{% endblock %}
{% block description %}注册账号 保险管家{% endblock %}
{% block content %}
    <div class="row row-content" style="padding-top: 50px">
        <form class="col-xs-12 form-horizontal" role="form" id="main-form" method="post">
            {% csrf_token %}
            <div class="form-group" style="text-align: center">
                <label class="radio-inline">
                    <input type="radio" name="usertype" id="optionsRadiosInline1" value="2"
                           {% if role != "buy" %}checked="checked"{% endif %}>我是保险代理人
                </label>
                <label class="radio-inline">
                    <input type="radio" name="usertype" id="optionsRadiosInline2" value="1"
                           {% if rol == "buy" %}checked="checked"{% endif %}>我是投保人
                </label>
            </div>
            <div class="form-group">
                {#                        <label for="firstname" class="col-xs-4 control-label">手机号：</label>#}
                <div class="col-xs-12">
                    <input type="text" class="form-control"
                           placeholder="请输入手机号" id="phone" name="tel">
                </div>
            </div>
            <div class="form-group">
                {#                        <label for="lastname" class="col-xs-4 control-label">动态验证码</label>#}
                <div class="col-xs-9">
                    <input type="text" class="form-control" id="code" name="safe-code"
                           placeholder="请输入短信验证码" style="width: 100%">
                </div>
                <button type="button" class="col-xs-3 btn btn-primary" id="sendmsg"

                >发送验证码
                </button>
            </div>

            <div class="form-group">
                {#                        <label for="firstname" class="col-xs-4 control-label">手机号：</label>#}
                <div class="col-xs-12">
                    <input class="form-control"
                           placeholder="设置密码" id="password" name="password" type="password">
                </div>
            </div>
            <div data-toggle="distpicker" id="distpicker" style="padding-bottom: 15px">
                        <select class="form-control" name="region1"    style="width: 45%;display: inline-block" ></select>
                        <select class="form-control" name="region2"  style="width: 45%;display: inline-block;"></select>
            </div>

            <div class="form-group">
                <div class="col-xs-12">
                    <div>
                        <button type="submit" class="btn btn-primary  btn-block" style="width: 100%">提交</button>
                    </div>

                </div>
            </div>
        </form>
    </div>
    <div class="row row-content">
    <div class="col-xs-12 " >
        <a href="/login/">已有账号，立刻登录</a>
        <a href="/forgotpwd/" class="pull-right">忘记密码</a>
    </div>

    </div>
    <div>

                            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                                            <h4 class="modal-title" id="myModalLabel"></h4>
                                        </div>
                                        <div class="modal-body" id="myModeal-body">

                                        </div>
{#                                        <div class="modal-footer">#}
{#                                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>#}
{#                                            <a  href="/logout/?next=/" type="button" class="btn btn-primary">确定</a>#}
{#                                        </div>#}
                                    </div>
                                    <!-- /.modal-content -->
                                </div>
                                <!-- /.modal-dialog -->
                            </div>
    </div>
{% endblock %}
{% block footer %}
{% endblock %}
{% block customjs %}
    <script src="/static/jquery.validater.min.js"></script>
    <script src="/static/js/distpicker/distpicker.js"></script>
    <script>
        jQuery.validator.addMethod("isMobile", function (value, element) {
            var length = value.length;
            var mobile = /^(1[0-9]{2}\d{8})$/;
            return this.optional(element) || (length == 11 && mobile.test(value));
        }, "请正确填写您的手机号码");

        function modal_message(message,msec){
            jQuery("#myModeal-body").text(message);
            jQuery("#myModal").modal("show");
            setTimeout(function(){
                jQuery("#myModal").modal("hide");

            },msec)
        }
        function direct_302(address,msec){
            setTimeout(function(){
                 window.location.href=address
            },msec);
        }
        function process_response(data){
            var errcode=data.errorCode;
            if (errcode){
                var errmessage=data.formError.fields[0].msg;
                modal_message(errmessage,1200);
            }
            else {
                var successmsg=data.msg;
                var direct_to=data.formSuccess.redirect;
                var msec=data.formSuccess.duration;
                modal_message(successmsg,1200);
                direct_302(direct_to,msec)
            }
        }

        $(document).ready(function () {
            function sendsms_callback(x) {
                var phone_valid = $("#phone").valid();
                if (phone_valid) {
                    $.getJSON("/register_send_sms/?tel=" + $("#phone").val(), function (data) {
                    });
                    var interval_flag = 60;
                    var _ = setInterval(function () {
                        console.log(interval_flag);
                        if (interval_flag >= 0) {
                            $("#sendmsg").text(interval_flag);
                            $("#sendmsg").attr("disabled", "disabled");
                            interval_flag -= 1
                        }
                        else {
                            $("#sendmsg").text("重新发送");
                            $("#sendmsg").removeAttr("disabled");
                            clearInterval(_);
                        }

                    }, 1000);
                }

            }

            $("#sendmsg").click(sendsms_callback);


            $("#main-form").validate({
                        rules: {
                            tel: {
                                required: true,
                                isMobile: true,
                                remote:"/m_register_valid_phone"
                            },
                            "safe-code": {
                                required: true
                            },
                            password:{
                                required:true
                            }

                        },
                        messages: {
                            tel: {
                                required: "请输入手机号",
                                remote: "该手机号已被其他用户占用"
                            },
                            "safe-code": {
                                required: "请输入短信验证码"
                            },
                            password:{
                                required:"请设置密码"
                            }
                        },

                        submitHandler:function(form){

                            jQuery.ajax({
                                type:"POST",
                                dataType:"json",
                                data: jQuery(form).serialize(),
                                success:function(data){
                                    process_response(data);
                                }

                            })
                        }

                    }
            );
        });
        $("#distpicker").distpicker({
        {% if request.province_id %}
            province: '{{ request.province_id }}',
            {% if request.city_id %}
                city: '{{ request.city_id }}',
            {% endif %}
        {% endif %}
    })
    </script>
{% endblock %}