{% extends "m_base.html" %}
{% block header_title %}保险问吧{% endblock %}
{% block title %}保险问吧-保险管家{% endblock %}
{% block keywords %}保险问吧 保险管家{% endblock %}
{% block description %}保险问吧 保险管家{% endblock %}
{% load math %}
{% load range %}
{% block content %}
    <div class="row row-content" style="padding-top: 10px">
        <div class="chat-panel panel panel-default" style="margin-bottom: 0px;">
            <div class="panel-heading">
                <i class="glyphicon  glyphicon-pencil    fa-fw"></i>提交问题
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body" style="height: auto;overflow: auto;padding:5px 5px;">
                <form role="form" id="main-ask-form" method="post" action="/ask/">
                    {% csrf_token %}
                    <div style="display: none ">
                        <input name="next" value="/ask/" style="display: none">
                    </div>
                    <div class="form-group" style="margin-bottom: 5px">

                        <textarea class="form-control" rows="3" placeholder="请描述你的问题(不超过200字)" name="content"
                                  required="required"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 5px">
                        <div style="float: right">
                            <div>
                                <button type="submit" class="btn  btn-primary btn-sm " style="width: 70px">提交</button>
                            </div>

                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <div class="row row-content">
        <div class="chat-panel panel panel-default" style="margin-bottom: 0px;">
            <div class="panel-heading">
                <i class="glyphicon  glyphicon-question-sign    fa-fw"></i>所有问答
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body" style="height: auto;overflow: auto">
                <ul class="chat">
                    {% for ask in allinfo %}
                        {% with ask_user=ask.get_user %}
                            <li class="left clearfix">
                                    <span class="chat-img pull-left">
                                        <img src="{{ ask_user.get_img_url }}" alt="User Avatar"
                                             class="img-circle" style="width: 50px;height: 50px">
                                    </span>
                                <div class="chat-body clearfix">
                                    <div class="header">
                                        <strong class="primary-font">{{ ask_user.get_hide_namecontent }}</strong>
                                        <small class="pull-right text-muted">
                                            <i class="fa fa-clock-o fa-fw"></i> {{ ask.get_date_time }}
                                        </small>
                                    </div>
                                    <p>
                                        <a href="/ask/detail/{{ ask.askid }}.html"
                                           style="color: #333">{{ ask.ask_content }}</a>
                                    </p>
                                </div>
                                <div style="font-size: 85% ;padding-top: 2px;color:{% if not   ask.get_answer_count %}#777;{% else %}#337ab7{% endif %}">
                                    <i class="fa fa-comment-o">&nbsp;</i>{{ ask.get_answer_count }}个回答
                                    {% if ask.get_answer_count %}
                                        {% with last_ans=ask.get_last_ans %}
                                            {% with last_ans_user=last_ans.get_user %}
                                                {{ last_ans_user.get_namecontent }} 于{{ last_ans.get_date_time }}提交了新的答案
                                            {% endwith %}
                                        {% endwith %}
                                    {% endif %}
                                </div>
                            </li>
                        {% endwith %}
                    {% endfor %}

                </ul>
            </div>
        </div>
    </div>

    {% if allinfo.paginator.num_pages >= 2 %}
        <div style="text-align: center">
            <ul class="pagination">
                {% if allinfo.has_previous %}
                    <li><a href="/ask/{{ allinfo.previous_page_number }}/">
                        &lt;</a></li>
                {% endif %}
                {% for t in allinfo.number|near:3 %}
                    {% if t > 0 and t <= allinfo.paginator.num_pages %}
                        <li class=" {% if t == allinfo.number %}active{% endif %}"><a href="/ask/{{ t }}/"
                        >{{ t }}</a></li>
                    {% endif %}
                {% endfor %}
                {% if allinfo.has_next %}
                    <li><a href="/ask/{{ allinfo.next_page_number }}/">&gt;</a></li>
                {% endif %}
            </ul>
        </div>
    {% endif %}




    <div>

        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                        <h4 class="modal-title" id="myModalLabel"></h4>
                    </div>
                    <div class="modal-body" id="myModeal-body">

                    </div>
                    {#                                        <div class="modal-footer">#}
                    {#                                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>#}
                    {#                                            <a  href="/logout/?next=/" type="button" class="btn btn-primary">确定</a>#}
                    {#                                        </div>#}
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
    </div>
    <div>

        <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="loginModalLabel">请登录</h4>
                    </div>
                    <div class="modal-body" id="loginModeal-body" style="padding: 3px 3px;">
                        <div class="row row-content" style="padding-top: 1px">
                            <div class="alert alert-danger alert-dismissable" id="login-error-message" style="display: none">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                                <p></p>

                            </div>
                            <div class="alert alert-info alert-dismissable" id="login-success-message" style="display: none">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                                <p></p>
                            </div>
                            <form class=" col-xs-12 form-horizontal" role="form" id="main-form" method="post"
                                  action="/login/?next=%2Fask%2F">
                                {% csrf_token %}

                                <div class="form-group">
                                    {#                        <label for="firstname" class="col-xs-4 control-label">手机号：</label>#}
                                    <div class="col-xs-12">
                                        <input type="text" class="form-control"
                                               placeholder="手机号" id="username" name="username">
                                    </div>
                                </div>


                                <div class="form-group">
                                    {#                        <label for="firstname" class="col-xs-4 control-label">手机号：</label>#}
                                    <div class="col-xs-12">
                                        <input class="form-control"
                                               placeholder="密码" id="password" name="password" type="password">
                                    </div>
                                </div>


                                <div class="form-group">
                                    <div class="col-xs-12">
                                        <div>
                                            <button type="submit" class="btn btn-primary  btn-block"
                                                    style="width: 100%">提交
                                            </button>
                                        </div>

                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="row row-content" style="padding-bottom: 15px">
                            <div class="col-xs-offset-1 col-xs-10">
                                <a href="/register/">注册</a>
                                <a href="/forgotpwd/" class="pull-right">忘记密码</a>
                            </div>

                        </div>
                    </div>

                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
    </div>
    {% include "m_dailiren_common.html" %}
{% endblock %}
{#{% block footer %}#}
{#{% endblock %}#}
{% block customjs %}
    <script src="http://static.runoob.com/assets/jquery-validation-1.14.0/dist/jquery.validate.min.js"></script>
    <script>
        jQuery.validator.addMethod("isMobile", function (value, element) {
            var length = value.length;
            var mobile = /^(1[0-9]{2}\d{8})$/;
            return this.optional(element) || (length == 11 && mobile.test(value));
        }, "请正确填写您的手机号码");

        function modal_message(message, msec) {
            jQuery("#myModeal-body").text(message);
            jQuery("#myModal").modal("show");
            setTimeout(function () {
                jQuery("#myModal").modal("hide");

            }, msec)
        }
        function direct_302(address, msec) {
            setTimeout(function () {
                window.location.href = address
            }, msec);
        }
        function process_response(data) {
            var errcode = data.errorCode;
            if (errcode) {
                if (errcode == 500) {
                    var errmessage = data.formError.fields[0].msg;
                    modal_message(errmessage, 1200);
                }
                else if (errcode == 800) {
                    jQuery("#loginModal").modal("show");

                }

            }
            else {
                var successmsg = data.msg;
                var direct_to = data.formSuccess.redirect;
                var msec = data.formSuccess.duration;
                modal_message(successmsg, 1200);
                direct_302(direct_to, msec)
            }
        }

        $(document).ready(function () {


            $("#main-ask-form").validate({
                        rules: {
                            content: {
                                required: true
                            }

                        },
                        messages: {
                            content: {
                                required: "请输入问题描述"
                            }
                        },

                        submitHandler: function (form) {

                            jQuery.ajax({
                                url:jQuery(form).attr("action"),
                                type: "POST",
                                dataType: "json",
                                data: jQuery(form).serialize(),
                                success: function (data) {
                                    process_response(data);
                                }

                            })
                        }

                    }
            );
            $("#main-form").validate({
                        rules: {
                            username: {
                                required: true,
                                isMobile: true
                            },

                            password:{
                                required:true
                            }

                        },
                        messages: {
                            username: {
                                required: "请输入手机号"
                            },

                            password:{
                                required:"请填写密码"
                            }
                        },

                        submitHandler:function(form){
                            jQuery.ajax({
                                url:jQuery(form).attr("action"),
                                type:"POST",
                                dataType:"json",
                                data: jQuery(form).serialize(),
                                success:function(data){
                                    var error_code=data.errorCode;
                                    if (error_code==500){
                                        jQuery("#login-success-message").hide();
                                        jQuery("#login-error-message>p").text(data.formError.fields[0].msg);
                                        jQuery("#login-error-message").show();
                                    }
                                    else if(error_code==0){
                                        jQuery("#login-error-message").hide();
                                        jQuery("#login-success-message>p").text(data.msg);
                                        jQuery("#login-success-message").show();
                                        var direct_to = data.formSuccess.redirect;
                                        direct_302(direct_to, 1000);
                                        //setTimeout()
                                    }
                                    //process_response(data);
                                }

                            })
                        }

                    }
            );
        });

    </script>
{% endblock %}