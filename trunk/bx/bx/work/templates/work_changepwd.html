{% extends "work_base.html" %}
{% block content %}
    {% load math %}
    <div id="page-wrapper">
        <div class="row">
            <div class="col-lg-12">
                <h3 class="page-header hd"> 修改密码</h3>
            </div>

        </div>
        <div class="row" style="margin-top: 30px;">
        </div>

        {% if not request.myuser.phone %}
            <div class="row">
                <div class="alert alert-danger">
                    {% if request.myuser.is_3login %}您是三方登录账户.{% endif %}
                    您尚未完成手机号认证! 完成认证后才能修改密码！ <a href="/work/phonevalid/" class="alert-link">点此</a> 进入认证.
                </div>

            </div>
        {% else %}
            {% if  success_msg %}
                <div class="row">
                    <div class="col-lg-6 alert alert-success">
                        {{ success_msg }}
                    </div>
                </div>
            {% else %}

                <div class="row">
                    <div class="col-lg-6 alert alert-success">
                        温馨提示：请妥善保存接收到的短信验证码。
                    </div>
                </div>

                <div class="row" style="padding-top: 20px">
                    <form class="col-lg-5 form-horizontal" role="form" id="main-form" method="post">
                        {% csrf_token %}

                        <div class="form-group">
                            <label for="lastname" class="col-sm-4 control-label">动态验证码</label>
                            <div class="col-sm-5">
                                <input type="text" class="form-control" id="code" name="code"
                                       placeholder="请输入短信验证码" style="width: 100%">
                            </div>
                            <button type="button" class="btn btn-primary" id="sendmsg"
                                    style="width: 100px"
                            >发送验证码
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-4 control-label">新密码：</label>
                            <div class="col-sm-8">
                                <input class="form-control" required="required" name="pwd" id="pwd" type="password"
                                >
                            </div>


                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 control-label">再次输入密码：</label>
                            <div class="col-sm-8">
                                <input class="form-control" required="required" name="pwd_again" id="pwd_again"
                                       type="password"
                                >
                            </div>


                        </div>

                        <div class="form-group">
                            <div class="col-sm-offset-2 col-sm-10">
                                <div style="width: 132px;margin: 0 auto ">
                                    <button type="submit" class="btn btn-default" style="width: 130px">提交</button>
                                </div>

                            </div>
                        </div>
                    </form>
                </div>

            {% endif %}

        {% endif %}
    </div>

{% endblock %}

{% if request.myuser.phone %}
{% block custom_js %}
    <script src="http://static.runoob.com/assets/jquery-validation-1.14.0/dist/jquery.validate.min.js"></script>
    <script>
        jQuery.validator.addMethod("pwdagain", function (value, element) {
            return $("#pwd").val() == value;
        }, "两次输入的密码不一致");


        $(document).ready(function () {
            function sendsms_callback(x) {
                $.getJSON("/work/change_pwd/?go={{ request.myuser.phone }}", function (data) {
                });
                var interval_flag = 60;
                var _ = setInterval(function () {
                    console.log(interval_flag);
                    if (interval_flag >= 0) {
                        $("#sendmsg").text(interval_flag);
                        $("#sendmsg").attr("disabled", "disabled");
                        interval_flag -= 1
                    }
                    else {
                        $("#sendmsg").text("重新发送");
                        $("#sendmsg").removeAttr("disabled");
                        clearInterval(_);
                    }

                }, 1000);
            }

            $("#sendmsg").click(sendsms_callback);

            $("#main-form").validate({
                        rules: {
                            code: {
                                required: true,
                                remote: "/work/phonevalid/?code_valid=1"
                            },
                            pwd: {
                                required: true,
                                minlength: 6
                            },
                            pwd_again: {
                                required: true,
                                pwdagain: true

                            }

                        },
                        messages: {
                            code: {
                                required: "请输入短信验证码",
                                remote: "验证码不正确或已过期"
                            },
                            pwd: {
                                required: "请输入密码",
                                minlength: "密码长度不能小于6位"
                            },
                            pwd_again: {
                                required: "请再次输入密码",
                                pwdagain: "两次输入的密码不一致"
                            }
                        }

                    }
            );
        });
    </script>
{% endblock %}
{% endif %}