{% extends "work_base.html" %}

{% block content %}
    {% load math %}
    <div id="page-wrapper">
        <div class="row">
            <div class="col-lg-12">
                <h3 class="page-header hd"> 手机认证</h3>
            </div>

        </div>
        <div class="row" style="margin-top: 15px;">
        </div>
        {% if  request.myuser.phone %}
            <div class="row">
                <div class="col-lg-6 alert alert-info">
                    温馨提示：您已完成手机号认证! 您可通过手机号登录或更改密码！
                </div>
            </div>
            <div class="row">
                <div>
                    <span class="label label-default">当前认证手机号：</span>
                    <p style="display: inline-block;padding-left: 15px ;color: #337ab7">{{ request.myuser.phone }}</p>
                </div>
            </div>

        {% else %}
            <div class="row">
                <div class="col-lg-6 alert alert-success">
                    温馨提示：完成手机认证后，您可以直接用手机号进行登陆、找回密码、更改密码等操作。
                </div>
            </div>

            <div class="row" style="padding-top: 20px">
                <form class="col-lg-5 form-horizontal" role="form" id="main-form" method="post">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="firstname" class="col-lg-4 control-label">手机号：</label>
                        <div class="col-lg-8">
                            <input type="text" class="form-control"
                                   placeholder="请输入手机号"  id="phone" name="phone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="lastname" class="col-sm-4 control-label">动态验证码</label>
                        <div class="col-sm-5">
                            <input type="text" class="form-control" id="code" name="code"
                                   placeholder="请输入短信验证码" style="width: 100%">
                        </div>
                                                <button  type="button" class="btn btn-primary" id="sendmsg"
                                                         style="width: 100px"
                                                >发送验证码</button>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <div style="width: 132px;margin: 0 auto ">
                                <button type="submit" class="btn btn-default" style="width: 130px">提交</button>
                            </div>

                        </div>
                    </div>
                </form>
            </div>


        {% endif %}


    </div>

{% endblock %}

{% block custom_js %}
    <script src="http://static.runoob.com/assets/jquery-validation-1.14.0/dist/jquery.validate.min.js"></script>
    <script>
        jQuery.validator.addMethod("isMobile", function(value, element) {
          var length = value.length;
          var mobile = /^(1[0-9]{2}\d{8})$/;
          return this.optional(element) || (length == 11 && mobile.test(value));
        }, "请正确填写您的手机号码");


        $(document).ready(function () {
            function sendsms_callback(x){
                var phone_valid=$("#phone").valid();
                if (phone_valid){
                    $.getJSON("/work/phonevalid/?go="+$("#phone").val(),function(data){
                    });
                var interval_flag=60;
                var _= setInterval(function(){
                    console.log(interval_flag);
                    if (interval_flag>=0){
                        $("#sendmsg").text(interval_flag);
                        $("#sendmsg").attr("disabled","disabled");
                        interval_flag-=1
                    }
                    else {
                        $("#sendmsg").text("重新发送");
                        $("#sendmsg").removeAttr("disabled");
                        clearInterval(_);
                    }

                        },1000);
                }

            }

            $("#sendmsg").click(sendsms_callback);


            $("#main-form").validate({
                rules:{
                    phone:{
                        required:true,
                        isMobile:true,
                        remote:"/work/phonevalid/?remote_valid=1"
                    },
                    code:{
                        required:true,
                        remote:"/work/phonevalid/?code_valid=1"
                    }

                },
                messages:{
                    phone:{
                        required:"请输入手机号",
                        remote:"该手机号已被其他用户占用"
                    },
                    code:{
                        required:"请输入短信验证码",
                        remote:"验证码不正确或已过期"
                    }
                },
                success:function(x){
                    if($(x[0]).attr("for")=="phone"){
                        $("#sendmsg").removeAttr("disabled");

                    }
                }

            }

            );
        });
    </script>
{% endblock %}